// Fill out your copyright notice in the Description page of Project Settings.

#pragma once
#include "MeComposite.h"
#include "Modules/CommonTypes/MulticastDelegate.h"
#include "Modules/MathElementsV2/CompatibilityData.h"
#include "Modules/MathElementsV2/MathElementPath.h"

struct FTAMeHelpers;

namespace MathElementV2
{
	class FTAMeDocument : public FTAMeComposite
	{
		TYPED_CLASS_META(FTAMeDocument, FTAMeComposite)
		friend FTAMeHelpers;

	protected:
		FTAMeDocument();
		virtual float GetScalingFactor(int ChildIndex) override;
	public:
		/**
		 * You can only add math elements just generated by factory
		 * @param Path Path in math tree
		 * @param InMathElements Elements to add
		 */
		void AddMathElements(const FTAMePath& Path, const std::wstring& InMathElements);
		void RemoveMathElements(FTAMePath Path, int Count);
		void SetMeGenerator(const std::weak_ptr<FTAMathElementGenerator>& InGenerator);
		int GetVisibleFrom() const { return VisibleFrom; }
		int GetVisibleTo() const { return VisibleTo; }

		void ScrollY(int Count);
		void ScrollYDelta(float& Delta);
		void InvokeOnScrolled();
		void SetHeight(float InHeight);
	private:
		void UpdateLinesCount(int Count);
		void SetDocumentToChildren(const FMathElements& MathElements);
		void ArrangeVisibleElements();
		std::weak_ptr<FTAMathElementGenerator> Generator;
		//Think of it as How many lines of ordinary symbols can fit on the page
		float Height;
		int VisibleFrom;
		int VisibleTo;

		int LinesCount;
		int CurrentLine;
		//This value used only for visual purpose, don't rely on it
		//It stores approximate number of lines that could fit on the page
		int LinesOnPage;

		int FirstLineMeCount;
	public:
		FTAMulticastDelegate<const FTAMePath&, const FMathElements&> OnMeAdded;
		FTAMulticastDelegate<const FTAMePath&, const std::wstring&, int> OnMeRemoved;
		FTAMulticastDelegate<int /*LinesNum*/, int /*CurrentLine*/> OnScrolled;
		FTAMulticastDelegate<int /*LinesNum*/, int /*LinesOnPage*/> OnLinesCountUpdated;
	};
}
